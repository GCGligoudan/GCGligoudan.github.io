<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用vue自定义指令来开发一个表单验证插件 | happy coding</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="have fun with coding">
    
    <link rel="preload" href="/assets/css/0.styles.5b2ad578.css" as="style"><link rel="preload" href="/assets/js/app.94b461fa.js" as="script"><link rel="preload" href="/assets/js/2.5be9efca.js" as="script"><link rel="preload" href="/assets/js/18.5a3baa3a.js" as="script"><link rel="prefetch" href="/assets/js/10.a4e8cb58.js"><link rel="prefetch" href="/assets/js/11.4fa810a3.js"><link rel="prefetch" href="/assets/js/12.7076bf3f.js"><link rel="prefetch" href="/assets/js/13.b142e5d4.js"><link rel="prefetch" href="/assets/js/14.025fb1ce.js"><link rel="prefetch" href="/assets/js/15.188f7a0a.js"><link rel="prefetch" href="/assets/js/16.e21d937e.js"><link rel="prefetch" href="/assets/js/17.a33a86e2.js"><link rel="prefetch" href="/assets/js/19.ebb61865.js"><link rel="prefetch" href="/assets/js/20.f8e29efd.js"><link rel="prefetch" href="/assets/js/3.3fb33442.js"><link rel="prefetch" href="/assets/js/4.4827a1f8.js"><link rel="prefetch" href="/assets/js/5.1c54c189.js"><link rel="prefetch" href="/assets/js/6.15c0cadb.js"><link rel="prefetch" href="/assets/js/7.6900bd78.js"><link rel="prefetch" href="/assets/js/8.d888e939.js"><link rel="prefetch" href="/assets/js/9.74a365ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5b2ad578.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">happy coding</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="blog" class="dropdown-title"><span class="title">blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="blog" class="mobile-dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/" class="nav-link">
  最新
</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">
  about
</a></li></ul></div></div> <a href="https://github.com/GCGligoudan" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="blog" class="dropdown-title"><span class="title">blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="blog" class="mobile-dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue3/" class="nav-link">
  最新
</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">
  about
</a></li></ul></div></div> <a href="https://github.com/GCGligoudan" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/vue3/" class="sidebar-link">关于vue3你需要知道的事</a></li><li><a href="/vue_jsx/" class="sidebar-link">vue中的渲染函数/jsx和插槽slot</a></li><li><a href="/vue_jwt/" class="sidebar-link">vue-router结合vuex实现用户权限控制</a></li><li><a href="/leetcode/" class="sidebar-link">常见leetCode算法题目分享</a></li><li><a href="/vue_validate_mixin/" class="sidebar-link">使用vue中的mixin功能优化表单校验插件</a></li><li><a href="/vue_validate/" aria-current="page" class="active sidebar-link">使用vue自定义指令来开发一个表单验证插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue_validate/#_1-vue插件开发" class="sidebar-link">1. vue插件开发</a></li><li class="sidebar-sub-header"><a href="/vue_validate/#_2-v-validateparams指令" class="sidebar-link">2. v-validateParams指令</a></li><li class="sidebar-sub-header"><a href="/vue_validate/#_3-表单插件的使用" class="sidebar-link">3. 表单插件的使用</a></li><li class="sidebar-sub-header"><a href="/vue_validate/#_4-当前方式存在的问题" class="sidebar-link">4. 当前方式存在的问题</a></li></ul></li><li><a href="/vue_test/" class="sidebar-link">vue单元测试vue test utils使用初探</a></li><li><a href="/node/" class="sidebar-link">初识nodejs</a></li><li><a href="/mxgraph/" class="sidebar-link">mxgraph入门解析</a></li><li><a href="/webpack4/" class="sidebar-link">webpack4配置入门和多文件打包</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h1> <p>这段时间在进行一个新项目的前期搭建，新项目框架采用vue-cli3和typescirpt搭建。因为项目比较轻量，所以基本没有使用额外的ui组件，有时候我们需要的一些基础组件我就直接自己开发了。今天就来介绍一下如何利用vue的自定义指令directive来开发一个表单验证插件的过程。本文是以ts为基础开发的，如果同学们需要js版的只需要把ts语法转为js即可。
</p> <h2 id="_1-vue插件开发"><a href="#_1-vue插件开发" class="header-anchor">#</a> 1. vue插件开发</h2> <p>关于vue的插件开发，官方文档里有很清晰的说明，详情可以去阅读<a href="https://cn.vuejs.org/v2/guide/plugins.html" target="_blank" rel="noopener noreferrer">开发文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这次开发的表单验证插件validate.ts就是利用了这种方式。</p> <ul><li>vue全局指令</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// myPlugin.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">install</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册一个my-directive指令</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'my-directive'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 逻辑</span>
      <span class="token punctuation">}</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// main.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> myPlugin <span class="token keyword">from</span> <span class="token string">'myPlugin'</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>myPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>上面是注册一个vue<a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener noreferrer">自定义指令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的写法，注册的时候，bind()函数为指令的钩子函数，其中的参数el表示指令绑定的元素，可以直接操作DOM。binding为一个对象，包括指令名称，绑定值等信息。vnode和oldVnode表示Vue编译生成的虚拟节点。</p> <p>我们通过注册一个全局指令v-validateParams指令，绑定到输入表单的input标签上来校验当前输入值是否符合要求。</p> <h2 id="_2-v-validateparams指令"><a href="#_2-v-validateparams指令" class="header-anchor">#</a> 2. v-validateParams指令</h2> <p>最开始我参考了网上的一些代码，思路如下：</p> <ul><li>整体思路</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">install</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册一个全局自定义指令 `v-validateParams`</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'validateParams'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当被绑定的元素插入到 DOM 中时</span>
      <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 给指令绑定的Dom元素添加事件监听，监测输入框失焦事件</span>
        <span class="token comment">// 每次当表单中的输入框失焦时执行函数</span>
        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 1.首先重置所有错误提示</span>
          <span class="token comment">// 2.获取自定义指令中传入的校验规则参数和表单输入的值</span>
          <span class="token comment">// 3.依次判断当前输入的值是否符合校验规则</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册一个全局自定义指令 `v-validateSubmit`，这个指令绑定到表单的提交button上</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'validateSubmit'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当被绑定的元素插入到 DOM 中时</span>
      <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 给提交button添加事件监听</span>
        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 获取当前组件内所有含有v-check类名的元素</span>
          <span class="token keyword">let</span> elements <span class="token operator">=</span> vNode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'v-check'</span><span class="token punctuation">)</span>
          <span class="token keyword">var</span> evObj <span class="token operator">=</span> vNode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">'Event'</span><span class="token punctuation">)</span>
          evObj<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> element <span class="token keyword">of</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 给所有v-check元素绑定blur事件</span>
            element<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 获取当前组件下的所有错误提示元素</span>
          <span class="token keyword">let</span> errorInputs <span class="token operator">=</span> vNode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'input-error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果组件中没有错误提示元素，则执行当前组件实例中的submit()函数</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>errorInputs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            vNode<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这里需要说明一下<code>validateSubmit</code>指令，这个指令绑定到提交按钮上，在点击的时候执行校验，校验通过之后执行提交操作。但是这里的实现方式不是特别友好:</p> <ol><li>需要获取当前组件中的所有input元素，给他们绑定并执行<code>blur</code>事件，以此来执行<code>validateParams</code>指令中的校验逻辑。</li> <li>获取当前组件中的所有错误提示元素，如果他们存在就表示没有通过校验，不能继续执行后面的逻辑。</li> <li>当组件内不含任何错误提示元素时，表示校验通过，执行当前组件内的<code>submit</code>函数，所以每个表单组件的提交函数都只能命名为<code>submit</code></li></ol> <p>我们再看下指令<code>validateParams</code>的内部实现。该指令需要绑定到表单<code>input</code>元素上，并把校验规则当作参数传入。当该input元素失焦时，会执行指令中给当前元素绑定的事件中的逻辑。这些逻辑分为三个步骤，我已经写在注释里了，现在我们来看下具体实现。</p> <ul><li>重置所有错误提示</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 重置当前节点样式
 * @param el: HTMLElement，传入当前绑定的input元素
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">resetError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  el<span class="token punctuation">.</span>className <span class="token operator">=</span> el<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'input-error'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> el<span class="token punctuation">.</span>parentNode <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ErrorNode <span class="token operator">=</span> el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.error-tips'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ErrorNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>ErrorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>获取自定义指令中传入的校验规则参数和表单输入的值</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// binding.value是传入自定义指令的参数，以数组的形式</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> rule <span class="token keyword">of</span> binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 分别获取到自己定义的校验规则并执行</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> min<span class="token punctuation">,</span> max<span class="token punctuation">,</span> message<span class="token punctuation">,</span> required<span class="token punctuation">,</span> pattern <span class="token punctuation">}</span> <span class="token operator">=</span> rule<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">!</span>required <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>InputEl<span class="token punctuation">.</span>value <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不符合校验，执行报错函数</span>
    <span class="token function">validateError</span><span class="token punctuation">(</span>InputEl<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> min <span class="token operator">&amp;&amp;</span> InputEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> min <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validateError</span><span class="token punctuation">(</span>InputEl<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> max <span class="token operator">&amp;&amp;</span> InputEl<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> max <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validateError</span><span class="token punctuation">(</span>InputEl<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> pattern <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>InputEl<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validateError</span><span class="token punctuation">(</span>InputEl<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> rule <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> rule <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rule</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>context<span class="token punctuation">,</span> InputEl<span class="token punctuation">.</span>value<span class="token punctuation">,</span> validateError<span class="token punctuation">,</span> InputEl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>校验不符合，执行报错函数</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 执行错误提示函数，用input-error 类名和含有错误信息的p元素表示未通过校验
 * @param el: HTMLElement，传入当前绑定的input元素
 * @param errorMsg: string，传入错误提示信息
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">validateError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span> errorMsg<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>classList<span class="token punctuation">,</span> <span class="token string">'input-error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果当前组件里已经有了错误提示信息，什么也不做</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> errorNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errorNode<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'error-tips'</span><span class="token punctuation">;</span>
    errorNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> errorMsg<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在当前input 元素后追加一个p元素，内容为错误提示</span>
      el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>errorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在当前input 元素上添加一个input-error类名</span>
    el<span class="token punctuation">.</span>className <span class="token operator">+=</span> <span class="token string">' input-error'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我就把自己实现的这个表单校验插件大致说完了，下面我们看下具体使用。</p> <h2 id="_3-表单插件的使用"><a href="#_3-表单插件的使用" class="header-anchor">#</a> 3. 表单插件的使用</h2> <p>首先新建校验规则文件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// rules.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">required</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  message<span class="token punctuation">,</span>
  required<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">min</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  message<span class="token punctuation">,</span>
  min<span class="token operator">:</span> length
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">max</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">15</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  message<span class="token punctuation">,</span>
  max<span class="token operator">:</span> length
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">pattern</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> reg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  message<span class="token punctuation">,</span>
  pattern<span class="token operator">:</span> reg
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// form.vue</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-item&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;userEmail&quot;</span><span class="token operator">&gt;</span>用户名：<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;userEmail&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'v-check'</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">&quot;userName&quot;</span>
        v<span class="token operator">-</span>validateParams<span class="token operator">=</span><span class="token string">&quot;[inputNameRequired, inputNameMin, inputNameMax, inputNamePattern]&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;success&quot;</span> v<span class="token operator">-</span>checkSubmit<span class="token operator">&gt;</span>确认<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script lang<span class="token operator">=</span><span class="token string">'ts'</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Vue<span class="token punctuation">,</span> Prop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-property-decorator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> max<span class="token punctuation">,</span> min<span class="token punctuation">,</span> required<span class="token punctuation">,</span> name<span class="token punctuation">,</span> pattern<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rules'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Auth</span> <span class="token keyword">extends</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> userName<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> inputNameMax <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'请不要超过20个字符'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> inputNameMin <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'请不要小于3个字符'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> inputNameRequired <span class="token operator">=</span> <span class="token function">required</span><span class="token punctuation">(</span><span class="token string">'请输入用户名'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> inputNamePattern  <span class="token operator">=</span> <span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">'请输入符合要求的用户名'</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9_-]{4,16}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'通过校验'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>通过这个例子我们可以看到，使用时需要将校验规则引入并赋给vue实例中的数据。然后在模板中，需要给<code>input</code>标签添加<code>v-check</code>类名，再使用<code>v-validateParams</code>指令，并传入参数。提交按钮需要调用<code>v-checkSubmit</code>指令。按照这种方式就能够使用自己开发的这个表单校验插件。</p> <h2 id="_4-当前方式存在的问题"><a href="#_4-当前方式存在的问题" class="header-anchor">#</a> 4. 当前方式存在的问题</h2> <p>虽然表单校验可以使用了，但是存在一些显而易见的问题：</p> <ol><li>js和html耦合度较高，插件还需要获取dom元素，组件的html模板中还需要添加制定类名。</li> <li>在vue中使用dom操作，不符合vue的设计思路，实现方式也不优雅。</li> <li>校验规则的校验逻辑在指令定义时写定了，添加或删除都需要改动插件代码。</li> <li>提交指令根据当前组件内的是否含有特定dom来判断当前校验状态，且执行提交的函数名称也在指令逻辑中写定了。</li></ol> <p>我根据现有一个demo结合着自己的需求来实现的这个表单校验插件，开发的过程中我已经知道这么写问题很多，同时也清楚的认识到自己的javascript水平还很初级，需要继续努力学习。</p> <p>当前开发的表单插件的主要问题在于如何将插件中的校验状态返回到组件内。我们可以在插件内维护一个事件处理函数，将校验规则传入并校验，再将校验结果直接传给组件内。这样就可以避免大量的dom操作。之后我需要尽快对这个插件进行更科学合理的重构。</p> <h1 id="更新-对表单插件的优化"><a href="#更新-对表单插件的优化" class="header-anchor">#</a> <a href="https://tech.gtxlab.com/mixin-validate.html" target="_blank" rel="noopener noreferrer">更新：对表单插件的优化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h1> <h1 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h1> <p><a href="https://cn.vuejs.org/v2/guide/plugins.html" target="_blank" rel="noopener noreferrer">vue插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener noreferrer">vue自定义指令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/u010536377/article/details/78715232" target="_blank" rel="noopener noreferrer">vue使用自定义指令实现表单校验<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5c90e141e51d4579a6301451" target="_blank" rel="noopener noreferrer">重构：从 0.1 构建一个 Vue 表单验证插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://segmentfault.com/a/1190000007575302" target="_blank" rel="noopener noreferrer">va.js——Vue 表单验证插件的写作过程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <hr> <p><em>作者简介： 宫晨光，<a href="http://www.genetalks.com/about-us.html" target="_blank" rel="noopener noreferrer">人和未来<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>大数据前端工程师。</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue_validate_mixin/" class="prev">
        使用vue中的mixin功能优化表单校验插件
      </a></span> <span class="next"><a href="/vue_test/">
        vue单元测试vue test utils使用初探
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.94b461fa.js" defer></script><script src="/assets/js/2.5be9efca.js" defer></script><script src="/assets/js/18.5a3baa3a.js" defer></script>
  </body>
</html>
